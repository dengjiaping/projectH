<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no"/>
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <title>应用邀请</title>
    <meta name="keywords" content="后会有期"/>
    <meta name="description" content="后会有期"/>

    <link rel="stylesheet" href="../css/css.css" type="text/css"/><!--分享--样式-->
    <!--<script src="../js/jquery-1.10.1.min.js"></script>&lt;!&ndash;jquery文件&ndash;&gt;-->
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

    <script src="../js/common.js"></script><!--公共js方法-->
    <script src="../js/key.js" ></script><!-- 定义的 接口前缀-->
    <script src="https://static.mlinks.cc/scripts/dist/mlink.min.js"></script><!--魔窗-->
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.3&key=9ec731c426036a64c93d46f920b47d69"></script> <!--高德地图-->

    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script><!--微信JSsdk-->
    <srcipt src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></srcipt><!--微信JSsdk-->

    <link rel="stylesheet" href="../css/common.css"/>  <!-- 公共样式---要放在高德API的后面----不然有html,body---height:100%的问题-->
</head>
<body style="background: #eff3f6;">

<div class="yyyq_container">
    <div class="top_yyyq">
        <div class="yyyq_user">
            <img src="../images/tx2.jpg" class="yyyq_user_icon" alt=""/>
            <h1><span id="yy_user"><!--小棉袄--></span>邀请你加入后会无期</h1>
            <h2>线下活动5分钟急速组队</h2>
        </div>
        <img src="../images/yy1.png" class="" alt=""/>
    </div>
    <div class="lingqu_container">
        <div class="lingqu_btn">
            <span class="lingqu">
                <img src="../images/bling.png" alt=""/>
                <span>点击领取</span>
            </span>
        </div>
        <img src="../images/yy2.png" width="100%;" alt=""/>
        <img src="../images/yy4.png" class="zuo_yy" alt=""/>
        <img src="../images/yy3.png" class="you_yy" alt=""/>
    </div>


    <div class="fujintuijian">
        <h1><img src="../images/map.png" alt=""/>附近推荐</h1>
        <div id="tuijian_container">
            <img src="../images/load.gif" class="load_gif" alt=""/>
        </div>
    </div>
</div>

<!--浮在底部-->
<section>
    <div class="bom_xiazai">
        <img src="../images/cha.png" class="cha" alt=""/>
        <div class="logo_info">
            <img src="../images/logo.png" alt=""/>
                    <span>
                        <h3>后会有期</h3>
                        <h4>线下即时组队平台</h4>
                    </span>
            <div class="clear"></div>
        </div>
        <a href="" class="liji_load uploadapp">立即打开</a>
    </div>
</section>

<!--选择登陆方式-->
<div class="choose_way_modal">
    <div class="all_black_bg7">
        <div class="distable">
            <div class="distabcell">
                <div class="login_way">
                    <h1>选择登录方式</h1>
                    <div class="all_way">
                        <div class="way_weixin">
                            <img src="../images/way_wei.png" alt=""/>
                            <h5>微信</h5>
                        </div>
                       <!-- <div class="way_qq">
                            <img src="../images/way_q.png" alt=""/>
                            <h5>QQ</h5>
                        </div>-->
                        <div class="way_phone">
                            <img src="../images/way_phone.png" alt=""/>
                            <h5>手机</h5>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <img src="../images/close.png" class="close_modal close1" alt=""/>
                </div>
            </div>
        </div>
    </div>
</div>

<!--手机验证-->
<div class="phone_yanzheng_modal">
    <div class="all_black_bg7">
        <div class="distable">
            <div class="distabcell">
                <div class="phone_yanzheng">
                    <form>
                        <input type="number" class="get_phonenum" placeholder="输入手机号" onblur="this.placeholder='输入手机号'" onfocus="this.placeholder=''"/>
                        <input type="button" value="验证码" id="get_yzm" class="get_yzm"/>
                        <div class="clear"></div>
                        <input type="number" class="shuru_yzm" placeholder="输入验证码" onblur="this.placeholder='输入验证码'" onfocus="this.placeholder=''"/>
                        <input type="button" class="lingqu_libao" value="领取新手大礼包"/>
                    </form>
                    <img src="../images/close.png" class="close_modal close2" alt=""/>
                </div>
            </div>
        </div>
    </div>
</div>

<!--礼包领取----成功与否，-->

<div class="libao_modal">
    <div class="all_black_bg7">
        <div class="distable">
            <div class="distabcell">
                <div class="libao">
                    <p><!--领取成功<br/>请登录APP查看--></p>
                    <img src="../images/libao.png" class="libao_img" alt=""/>
                    <a href="" class="uploadapp libao_loadapp">去APP查看</a>
                    <img src="../images/close.png" class="close_modal close3" alt=""/>
                </div>
            </div>
        </div>

    </div>
</div>

<!---tishi---->
<div class="tishi">
    <div class="distable">
        <div class="distabcell">
            <div class="tishi_val">
                <!--对不起 &#45;&#45; 您的抽奖次数已用完-->
            </div>
        </div>
    </div>
</div>
<!---tishi---->

</body>



<script>
    var code;
    var userId  = getQueryString("userId");
    var roomId  = getQueryString("roomId");
    var origin  = getQueryString("origin");

    $(function () {
        code=getQueryString("code");
        load();
        loadMap();
        login();
        get_ticket();
    });

    //set传后app的参数
    switch (origin) {
        case 'WEIXIN':
            origin = "WX";
            break;
        case 'QQ':
            origin = "QQ";
            break;
        case 'WEIXIN_CIRCLE':
            origin = "WXPYQ";
            break;
        default:
            origin = "WEB";
            break;
    }
    function  login() {
        if(code){
            // code 传到后台，拿到用户信息，包括抽奖次数
            var params4={};
            if(userId){
                params4 = ({"code":code,"recommenderId":userId})
            }
            else{
                params4 = ({"code":code})
            }

            var isLogin = (localStorage.getItem("token") && localStorage.getItem("userid"));
            if(!isLogin){
                $.ajax({
                    type:'post',
                    dataType:'json',
                    url:ContextPath+'view/login',
                    data: params4,
                    success:function(json){
                        var data = json.data;
                        console.dir(json);
                        if(json.success){
                            $(".phone_yanzheng_modal").fadeOut();
                            $(".libao_modal p").html("领取成功<br/>请登录APP查看");
                            $(".libao_modal").fadeIn(500);

                            localStorage.setItem("userid", data.id);
                            localStorage.setItem("token", data.token);

                        }else{
                            $(".phone_yanzheng_modal").fadeOut();
                            $(".libao_modal p").html("您已经领取过啦<br/>不能重复领取哦");
                            $(".libao_modal").fadeIn(500);
                        }
                    },
                    error: function (json) {
                        //领取失败
                        $(".tishi").fadeIn(500);
                        $(".tishi_val").html('登陆失败 - 请重试');
                        tishi_out();
                    }
                });
            }
        }
    }

    function tishi_out() {
        setTimeout(function () {
            $(".tishi").fadeOut(500);
        }, 1500)
    }//提示框2秒后消失

    //页面一加载就执行
    function load() {
        //modal
        $(".lingqu_btn").click(function () {
            $(".choose_way_modal").fadeIn(500);
        });
        $(".close1").click(function () {
            $(".choose_way_modal").fadeOut(200)
        });
        $(".close2").click(function () {
            $(".phone_yanzheng_modal").fadeOut(200);
        });
        $(".close3").click(function () {
            $(".libao_modal").fadeOut(200);
        });
        $(".way_phone").click(function () {
            $(".choose_way_modal").fadeOut(1000);
            $(".phone_yanzheng_modal").fadeIn(500);
        });

        //yaoqing_username--and--usericon
        var params2 = {"userId":userId};
        $.ajax({
            type:'post',
            dataType:'json',
            url:ContextPath+'user/findOtherInfo',
            data:params2,
            success:function(json){
                if(json.success){
                    var datas = json.data;
                    console.dir(datas);
                    $('.yyyq_user_icon').attr('src','https://tomeet-app-files.oss-cn-hangzhou.aliyuncs.com/user/'+datas.id+'/avatar?x-oss-process=image/resize,m_lfit,w_100,h_100');
                    $("#yy_user").append(datas.nickname);
                }else{
                    console.dir("失败-未获取到邀请人以及头像");
                }
            }
        });

        //yzm_login
        $("#get_yzm").click(function () {
            var params3={};
            var phone=$(".get_phonenum").val();
            if(!checkMobile(phone)) { alert("手机号码不正确"); }
            else {
                var params3 = {"phone":phone};
                invokeSettime("#get_yzm"); }
            $.ajax({
                type:'post',
                dataType:'json',
                url:ContextPath+'/view/getSmsCode',
                data:params3,
                success:(function (json) {
                    //如果手机号发送成功
                    if(json.success){
                        $(".lingqu_libao").click(function () {
                            $.ajax({
                                type: 'post',
                                dataType: 'json',
                                url: ContextPath + 'user/loginBySmsCode',
                                data: {"phone": $('.get_phonenum').val(), "smsCode": $(".shuru_yzm").val()},
                                success: (function (json) {
                                    console.dir(json);
                                    if(json,success){
                                        $(".phone_yanzheng_modal").fadeOut();
                                        $(".libao_modal").fadeIn(500);
                                        $(".libao_modal p").append("领取成功<br/>请登录APP查看");
                                    }else{
                                        if(json.msg == '验证码错误'){
                                            $(".tishi").fadeIn(500);
                                            $(".tishi_val").html('验证码错误，请重试');
                                            tishi_out();
                                        }
                                    }
                                })
                            });
                        });
                    }else{
                        if(json.msg == '发送失败'){
                            $(".tishi").fadeIn(500);
                            $(".tishi_val").html('验证码发送失败，请重试');
                            tishi_out();
                        }
                        if(json.msg == '您已注册过'){
                            $(".phone_yanzheng_modal").fadeOut(500);
                            $(".libao_modal p").append("您已经领取过啦<br/>不能重复领取哦");
                            $(".libao_modal").fadeIn(500);
                        }
                    }
                    //如果验证码发送失败或者此人已经注册过

                })
            });
        });

        //weixin_login
        $(".way_weixin").click(function () {
            getcode();
        });
    }

    function getcode() {
        localStorage.clear();
        var url_1 = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx1455b640ec310a00&redirect_uri='+location.href+'&response_type=code&scope=snsapi_login&state=1#wechat_redirect';
//        var url_code = 'https://open.weixin.qq.com/connect/qrconnect?appid=wx1455b640ec310a00&redirect_uri='+location.href+'&response_type=code&scope=snsapi_login&state='+state+'#wechat_redirect';
        location.href = url_1;
    }

    //经纬度定位
    function loadMap(){
        mapObj = new AMap.Map('iCenter');
        mapObj.plugin('AMap.Geolocation', function () {
            geolocation = new AMap.Geolocation({
                timeout: 100000,          //超过10秒后停止定位，默认：无穷大
                maximumAge: 600000
            });
            mapObj.addControl(geolocation);
            geolocation.getCurrentPosition();
            AMap.event.addListener(geolocation, 'complete', function () {
                window.position=arguments[0].position;
                var params={"gameId":0,"longitude":position.M,"latitude":position.O,"page":0,"size":10,"state":0};
                $.ajax({
                    type:'post',
                    dataType:'json',
                    url:ContextPath+'/room/findRoomsByGameOrder',
                    data:params,
                    success:function(json){
                        if(json.success){
                            var datas = json.data;
                            var $tuijianContainer=$('#tuijian_container').html('');

                            $.each(datas, function (index,obj) {

                                var $tuijian=$('<div class="tuijian"><div class="game_img_div"><div class="distable"><div class="distabcell"><img src="../images/game/'+obj.game.id+'.png" class="game_img"/></div></div></div></div>');

                                var $gameInfo=$(' <div class="game_info">'+
                                        '<h5 class="game_name">'+obj.name+'</h5>'+
                                        '<div class="place_container">'+
                                        '<div class="place_info">'+obj.place+'</div>'+
                                        '<div class="distance_info"><span> · </span>'+getjuli(obj.latitude,obj.longitude,position.O,position.M)+'km</div>'+
                                        '<div class="game_time">'+(obj.locked?'<img src="../images/mi.png" alt=""/>':'')+(obj.money>0?'<img src="../images/bao.png" alt=""/>':'')+
                                        obj.beginTime+'</div><div class="clear"></div></div>');
                                var $imgContainer=  $('<div class="adduser_tx"></div>');
                                $.each(obj.joinMembers,function(index,obj){
                                    var $img=$('<img src="'+'https://tomeet-app-files.oss-cn-hangzhou.aliyuncs.com/user/'+ obj.id+'/avatar'+'" alt=""/>');
                                    $imgContainer.append($img);
                                });
                                $gameInfo.append($imgContainer);
                                $tuijian.append($gameInfo);
                                var $clear=$('<div class="clear"></div>');
                                $tuijian.append($clear);
                                $tuijianContainer.append($tuijian);
                            })
                        }else{
                            $('#tuijian_container').html('<div class="zanwu">暂无</div>');
                        }
                    }
                });
            });//返回定位信息
            AMap.event.addListener(geolocation, 'error', function () {
                $('#tuijian_container').html('<div class="zanwu">暂无</div>');
            });      //返回定位出错信息
        })
    }

    //微信分享jssdk
    function get_ticket() {
        var signature;
        var noncestr;
        var timestamp;
        var urlurl;
        var nowurl = location.href;
        if (nowurl.indexOf('#') == -1) {
            urlurl = nowurl;
        }
        if (nowurl.indexOf('#') !== -1) {
            urlurl = get_urlurl(url);
        }
        $.ajax({
            type: 'get',
            dataType: 'json',
            url: ContextPath + '/view/getWXSignature',
            data: {"url": urlurl},
            success: function (json) {
                if (json.success) {
                    console.dir(json);
                    signature = json.data.signature;
                    noncestr = json.data.noncestr;
                    timestamp = json.data.timestamp;
                    wx.config({
                        debug: false,
                        appId: 'wx59b691c92ccb58e1',
                        timestamp: timestamp,
                        nonceStr: noncestr,
                        signature: signature,
                        jsApiList: [
                            'onMenuShareTimeline',
                            'onMenuShareAppMessage'
                        ]
                    });
                    wx.ready(function(){
                        var shareLinkUrl = 'https://hzease.com/share/share.html';
                        if (localStorage.getItem("userid")) {
                            shareLinkUrl = 'https://hzease.com/share/share.html?userId=' + localStorage.getItem("userid");
                        } else if (userId) {
                            shareLinkUrl = 'https://hzease.com/share/share.html?userId=' + userId;
                        }

                        wx.onMenuShareAppMessage({
                            title: '后会有期', // 分享标题
                            desc: '一款火爆组队APP',
                            link: shareLinkUrl,
                            imgUrl: 'https://hzease.com/images/logo.png',
                            type: 'link',
                            dataUrl: '',
                            success: function () {
                            },
                            cancel: function () {
                            }
                        });
                        wx.onMenuShareTimeline({
                            title: '后会有期',
                            link: shareLinkUrl,
                            imgUrl: 'https://hzease.com/images/logo.png',
                            success: function () {
                            },
                            cancel: function () {
                            }
                        });
                    });
                    wx.error(function(res){
                        console.dir(res)
                    });
                } else {
                    console.dir(json.msg);
                }

            }
        });
    }

    //去掉链接里‘#’后面 部分
    function get_urlurl(url) {
        var m = url.match(/[^#]+(?=[#])/g);
        return m[0];
    }
</script>

<!--魔窗-->
<script>
    new Mlink({
        mlink:'AcpY',//短链地址
        button:document.querySelectorAll('a.uploadapp'),
        autoLaunchApp : false,
        autoRedirectToDownloadUrl: true,
        downloadWhenUniversalLinkFailed: false,
        inapp : false,
        params: {action:'share', key1:userId, key2:origin}
    });
</script>

</html>